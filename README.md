This repo is an attempt to reproduce a memory leak issue with celery + pyamqp's heartbeat functionality: [https://github.com/celery/celery/issues/5047](https://github.com/celery/celery/issues/5047)

Start celery and rabbitmq by [installing docker & docker-compose](https://docs.docker.com/get-docker/) and running:
```sh
docker-compose up
```

1. Wait until you start seeing messages every 2 seconds about heartbeats.
1. Run this command to kill rabbitmq connections:
    ```bash
    sudo docker-compose exec rabbitmq /bin/sh -c 'rabbitmqadmin -f tsv -q list connections name | while read conn ; do rabbitmqadmin -q close connection name="${conn}" ; done'
    ```
1. Observe the `ConnectionResetError: [Errno 104] Connection reset by peer` error message generated by closing the connection.
1. Run `sudo docker stats` in another terminal window to watch memory usage.
1. Watch memory usage gradually increase by 300 KB every 10 seconds. 

You may need to run the command to kill rabbitmq connections multiple times. Sometimes it reconnects, but it's possible to get it into a bad state where it constantly says "Connection reset by peer".
